(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{1208:function(t,a,s){"use strict";s.r(a);var n=s(4),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"分布式锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分布式锁"}},[t._v("#")]),t._v(" 分布式锁")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("yudao-spring-boot-starter-protection")]),t._v(" "),a("OutboundLink")],1),t._v("技术组件，使用 Redis 实现分布式锁的功能，它有 2 种使用方式：")]),t._v(" "),a("ul",[a("li",[t._v("编程式锁：基于 "),a("a",{attrs:{href:"https://github.com/redisson/redisson",target:"_blank",rel:"noopener noreferrer"}},[t._v("Redisson "),a("OutboundLink")],1),t._v("框架提供的"),a("a",{attrs:{href:"https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8",target:"_blank",rel:"noopener noreferrer"}},[t._v("各种 "),a("OutboundLink")],1),t._v("分布式锁")]),t._v(" "),a("li",[t._v("声明式锁：基于 "),a("a",{attrs:{href:"https://github.com/baomidou/lock4j",target:"_blank",rel:"noopener noreferrer"}},[t._v("Lock4j "),a("OutboundLink")],1),t._v("框架的 "),a("code",[t._v("@Lock4j")]),t._v(" 注解")])]),t._v(" "),a("p",[t._v("Redis 分布式锁的实现原理？")]),t._v(" "),a("p",[t._v("参见 "),a("a",{attrs:{href:"https://www.iocoder.cn/Redis/good-collection/?yudao",target:"_blank",rel:"noopener noreferrer"}},[t._v("《Redis 实现原理与源码解析系列》 "),a("OutboundLink")],1),t._v("文章。")]),t._v(" "),a("h2",{attrs:{id:"_1-编程式锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-编程式锁"}},[t._v("#")]),t._v(" 1. 编程式锁")]),t._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.redisson"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("redisson-spring-boot-starter"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h3",{attrs:{id:"_1-1-redisson-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-redisson-配置"}},[t._v("#")]),t._v(" 1.1 Redisson 配置")]),t._v(" "),a("p",[t._v("无需配置。因为在 "),a("a",{attrs:{href:"https://doc.iocoder.cn/redis-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("Redis 缓存"),a("OutboundLink")],1),t._v(" 中，进行了 Spring Data Redis + Redisson 的配置。")]),t._v(" "),a("h3",{attrs:{id:"_1-2-实战案例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-实战案例"}},[t._v("#")]),t._v(" 1.2 实战案例")]),t._v(" "),a("p",[a("code",[t._v("yudao-module-pay")]),t._v(" 模块的 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-pay/yudao-module-pay-biz/src/main/java/cn/iocoder/yudao/module/pay/service/notify/PayNotifyServiceImpl.java#L155-L174",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("notify")]),t._v(" "),a("OutboundLink")],1),t._v("功能，使用到分布式锁，确保"),a("strong",[t._v("每个")]),t._v("支付通知任务有且仅有一个在执行。下面，来看看这个案例是如何实现的。")]),t._v(" "),a("p",[t._v("友情提示：")]),t._v(" "),a("p",[t._v("建议你已经阅读过 "),a("a",{attrs:{href:"https://doc.iocoder.cn/redis-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("《开发指南 —— Redis 缓存》"),a("OutboundLink")],1),t._v(" 文档。")]),t._v(" "),a("p",[t._v("① 在 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-pay/yudao-module-pay-biz/src/main/java/cn/iocoder/yudao/module/pay/dal/redis/RedisKeyConstants.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("RedisKeyConstants "),a("OutboundLink")],1),t._v("类中，定义通知任务使用的分布式锁的 Redis Key。如下图所示：")]),t._v(" "),a("img",{attrs:{src:s(615)}}),t._v(" "),a("p",[t._v("② 创建 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-pay/yudao-module-pay-biz/src/main/java/cn/iocoder/yudao/module/pay/dal/redis/notify/PayNotifyLockRedisDAO.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("PayNotifyLockRedisDAO "),a("OutboundLink")],1),t._v("类，使用 RedisClient 实现分布式锁的加锁与解锁。如下图所示：")]),t._v(" "),a("img",{attrs:{src:s(616)}}),t._v(" "),a("p",[t._v("③ 在 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-pay/yudao-module-pay-biz/src/main/java/cn/iocoder/yudao/module/pay/service/notify/PayNotifyServiceImpl.java#L155-L174",target:"_blank",rel:"noopener noreferrer"}},[t._v("PayNotifyServiceImpl "),a("OutboundLink")],1),t._v("执行指定的支付通知任务时，通过 PayNotifyLockRedisDAO 获得分布式锁。如下图所示：")]),t._v(" "),a("img",{attrs:{src:s(617)}}),t._v(" "),a("p",[t._v("技术选型：为什么不使用 Lock4j 提供的 LockTemplate 实现编程式锁？")]),t._v(" "),a("p",[t._v("两者各有优势，选择 Redisson 主要考虑它支持的 Redis 分布式锁的类型较多：可靠性较高的红锁、性能较好的读写锁等等。")]),t._v(" "),a("p",[t._v("Lock4j 的 LockTemplate 也是不错的选择，一方面不强依赖 Redisson 框架，一方面支持 ZooKeeper 等等。")]),t._v(" "),a("h2",{attrs:{id:"_2-声明式锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-声明式锁"}},[t._v("#")]),t._v(" 2. 声明式锁")]),t._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.baomidou"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("lock4j-redisson-spring-boot-starter"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h3",{attrs:{id:"_2-1-lock4j-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-lock4j-配置"}},[t._v("#")]),t._v(" 2.1 Lock4j 配置")]),t._v(" "),a("p",[t._v("在 "),a("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-server/src/main/resources/application-local.yaml#L111-L114",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("application-local.yaml")]),t._v(" "),a("OutboundLink")],1),t._v("配置文件中，通过 "),a("code",[t._v("lock4j")]),t._v(" 配置项，添加 Lock4j 全局默认的分布式锁配置。如下图所示：")]),t._v(" "),a("img",{attrs:{src:s(618)}}),t._v(" "),a("h3",{attrs:{id:"_2-2-使用案例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-使用案例"}},[t._v("#")]),t._v(" 2.2 使用案例")]),t._v(" "),a("p",[t._v("在需要使用到分布式锁的方法上，添加 "),a("code",[t._v("@Lock4j")]),t._v(" 注解，非常方便。示例代码如下：")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Service")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DemoService")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认使用 lock4j 配置项")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Lock4j")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("simple")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//do something")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 完全配置，支持 Spring EL 表达式")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Lock4j")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#user.id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#user.name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" expire "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" acquireTimeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("customMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports},615:function(t,a,s){t.exports=s.p+"assets/img/img_224.895a598e.png"},616:function(t,a,s){t.exports=s.p+"assets/img/img_225.2abf7e87.png"},617:function(t,a,s){t.exports=s.p+"assets/img/img_226.14a66034.png"},618:function(t,a,s){t.exports=s.p+"assets/img/img_227.615cad4c.png"}}]);