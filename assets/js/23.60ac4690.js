(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{1222:function(e,r,t){"use strict";t.r(r);var a=t(4),n=Object(a.a)({},(function(){var e=this,r=e._self._c;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"公众号接入"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#公众号接入"}},[e._v("#")]),e._v(" 公众号接入")]),e._v(" "),r("p",[e._v("本章节，讲解如果将你的公众号，接入到系统中。步骤如下：")]),e._v(" "),r("ul",[r("li",[e._v("第一步，申请公众号（可选）")]),e._v(" "),r("li",[e._v("第二步，在系统中，添加公众号账号")]),e._v(" "),r("li",[e._v("第三步，在公众号中，配置接入信息")])]),e._v(" "),r("h2",{attrs:{id:"_1-配置步骤"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置步骤"}},[e._v("#")]),e._v(" 1. 配置步骤")]),e._v(" "),r("p",[e._v("本小节，手把手教你如何将公众号接入到系统中。")]),e._v(" "),r("h3",{attrs:{id:"第一步-申请公众号-可选"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第一步-申请公众号-可选"}},[e._v("#")]),e._v(" 第一步，申请公众号（可选）")]),e._v(" "),r("p",[e._v("友情提示：如果你已经有公众号，可以忽略这一步。")]),e._v(" "),r("p",[e._v("① 如果你还没有公众号，可以申请一个测试帐号。")]),e._v(" "),r("img",{attrs:{src:t(731)}}),e._v(" "),r("p",[e._v("申请地址："),r("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信公众平台接口测试帐号申请"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("② 申请完成后，获得一个测试号。如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(732)}}),e._v(" "),r("h3",{attrs:{id:"第二步-添加公众号账号"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第二步-添加公众号账号"}},[e._v("#")]),e._v(" 第二步，添加公众号账号")]),e._v(" "),r("p",[e._v("点击 [公众号管理 -> 账号管理] 菜单，添加一个公众号账号。如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(733)}}),e._v(" "),r("h3",{attrs:{id:"第三步-配置接入信息"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第三步-配置接入信息"}},[e._v("#")]),e._v(" 第三步，配置接入信息")]),e._v(" "),r("p",[e._v("① 找一个内网穿透工具，转发到本地的 48080 端口。例如说，"),r("a",{attrs:{href:"https://ngrok.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ngrok "),r("OutboundLink")],1),e._v("、"),r("a",{attrs:{href:"https://github.com/fatedier/frp",target:"_blank",rel:"noopener noreferrer"}},[e._v("frp "),r("OutboundLink")],1),e._v("、"),r("a",{attrs:{href:"https://natapp.cn/",target:"_blank",rel:"noopener noreferrer"}},[e._v("natapa "),r("OutboundLink")],1),e._v("等等。")]),e._v(" "),r("p",[e._v("这里，我们使用 natapp 作为内网传统工具。访问 "),r("a",{attrs:{href:"https://natapp.cn/tunnel/buy/free",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://natapp.cn/tunnel/buy/free "),r("OutboundLink")],1),e._v("地址，免费购买一个隧道。如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(734)}}),e._v(" "),r("p",[e._v("② 购买完成后，参考 "),r("a",{attrs:{href:"https://natapp.cn/article/natapp_newbie",target:"_blank",rel:"noopener noreferrer"}},[e._v("《NATAPP 1 分钟快速新手图文教程》 "),r("OutboundLink")],1),e._v("文档，将 natapp 进行启动。如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(735)}}),e._v(" "),r("p",[e._v("③ 打开微信公众号界面，填写 URL 和 Token 信息。如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(736)}}),e._v(" "),r("p",[e._v("点击提交后，看到“配置成功”提示，说明配置成功。")]),e._v(" "),r("h2",{attrs:{id:"_2-实现代码"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-实现代码"}},[e._v("#")]),e._v(" 2. 实现代码")]),e._v(" "),r("p",[e._v("本小节，将介绍如何实现公众号接入的代码。")]),e._v(" "),r("h3",{attrs:{id:"_2-1-表结构"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-表结构"}},[e._v("#")]),e._v(" 2.1 表结构")]),e._v(" "),r("p",[e._v("公众号账号对应 "),r("code",[e._v("mp_account")]),e._v(" 表，结构如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(737)}}),e._v(" "),r("h3",{attrs:{id:"_2-2-账号管理界面"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-账号管理界面"}},[e._v("#")]),e._v(" 2.2 账号管理界面")]),e._v(" "),r("ul",[r("li",[e._v("前端："),r("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-ui-admin/src/views/mp/account/index.vue",target:"_blank",rel:"noopener noreferrer"}},[e._v("/@views/mp/account"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("后端："),r("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/account/MpAccountController.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("MpAccountController"),r("OutboundLink")],1)])]),e._v(" "),r("h3",{attrs:{id:"_2-3-配置接入回调"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-配置接入回调"}},[e._v("#")]),e._v(" 2.3 配置接入回调")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://doc.iocoder.cn/mp/account/#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%85%A5%E4%BF%A1%E6%81%AF",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三步，配置接入信息"),r("OutboundLink")],1),e._v(" 时，微信公众号会回调系统的 "),r("code",[e._v("GET /admin-api/mp/open/{appID}")]),e._v(" 接口，进行接入配置的验证。对应 "),r("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/open/MpOpenController.java#L39-L57",target:"_blank",rel:"noopener noreferrer"}},[e._v("MpOpenController "),r("OutboundLink")],1),e._v("类的 "),r("code",[e._v("checkSignature")]),e._v(" 方法，如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(738)}}),e._v(" "),r("p",[e._v("对应 "),r("a",{attrs:{href:"https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E7%A1%AE%E6%9D%A5%E8%87%AA%E5%BE%AE%E4%BF%A1%E6%9C%8D%E5%8A%A1%E5%99%A8",target:"_blank",rel:"noopener noreferrer"}},[e._v("《微信公众号官方文档 —— 接入指南》 "),r("OutboundLink")],1),e._v("文档。")]),e._v(" "),r("p",[e._v("友情提示：")]),e._v(" "),r("p",[e._v("项目使用的微信工具开发包是 "),r("a",{attrs:{href:"https://github.com/Wechat-Group/WxJava/tree/develop/weixin-java-mp",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("weixin-java-mp")]),e._v(" "),r("OutboundLink")],1),e._v("，超级好用！")]),e._v(" "),r("h3",{attrs:{id:"_2-4-消息处理"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-消息处理"}},[e._v("#")]),e._v(" 2.4 消息处理")]),e._v(" "),r("p",[e._v("配置接入完成后，用户发给公众号的消息，公众号都会回调到 "),r("code",[e._v("POST /admin-api/mp/open/{appID}")]),e._v(" 接口，进行消息的处理。对应 "),r("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/open/MpOpenController.java#L59-L114",target:"_blank",rel:"noopener noreferrer"}},[e._v("MpOpenController "),r("OutboundLink")],1),e._v("类的 "),r("code",[e._v("handleMessage")]),e._v(" 方法，如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(739)}}),e._v(" "),r("p",[e._v("核心逻辑是第二步，再解析到消息后，交给 WxMpMessageRouter 进行消息的处理。WxMpMessageRouter 在 "),r("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/open/MpOpenController.java#L59-L114",target:"_blank",rel:"noopener noreferrer"}},[e._v("DefaultMpServiceFactory "),r("OutboundLink")],1),e._v("初始化，设置每种消息对应的 "),r("a",{attrs:{href:"https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/service/handler/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("handler")]),e._v(" "),r("OutboundLink")],1),e._v("处理器。如下图所示：")]),e._v(" "),r("img",{attrs:{src:t(740)}}),e._v(" "),r("p",[e._v("具体每个处理器的实现，后续每个章节单独详细讲解。")])])}),[],!1,null,null,null);r.default=n.exports},731:function(e,r,t){e.exports=t.p+"assets/img/img_6.4bbce9c3.png"},732:function(e,r,t){e.exports=t.p+"assets/img/img_7.5b920c91.png"},733:function(e,r,t){e.exports=t.p+"assets/img/img_8.eebe7d47.png"},734:function(e,r,t){e.exports=t.p+"assets/img/img_9.3d0388dd.png"},735:function(e,r,t){e.exports=t.p+"assets/img/img_10.04fabe06.png"},736:function(e,r,t){e.exports=t.p+"assets/img/img_11.31b91a24.png"},737:function(e,r,t){e.exports=t.p+"assets/img/img_12.9e25b6b8.png"},738:function(e,r,t){e.exports=t.p+"assets/img/img_13.dc86c3e6.png"},739:function(e,r,t){e.exports=t.p+"assets/img/img_14.efa181f1.png"},740:function(e,r,t){e.exports=t.p+"assets/img/img_15.b7fcd9bc.png"}}]);